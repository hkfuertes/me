---
import type { Heading } from '../utils/add-heading-ids';

interface Props {
    headings: Heading[];
}

const { headings } = Astro.props;
---

{headings.length > 0 && (
    <nav class="toc-container hidden lg:block fixed right-8 top-32 w-64 max-h-[calc(100vh-12rem)] overflow-y-auto">
        <div class="text-xs font-semibold text-gray-900 mb-4 uppercase tracking-wider">
            On this page
        </div>
        <ul class="space-y-2 text-sm border-l-2 border-gray-200">
            {headings.map((heading) => (
                <li>
                    <a
                        href={`#${heading.id}`}
                        data-heading-id={heading.id}
                        class={`
                            toc-link block py-1 transition-colors
                            ${heading.level === 2 ? 'pl-4' : 'pl-8'}
                            text-gray-600 hover:text-gray-900
                        `}
                    >
                        {heading.text}
                    </a>
                </li>
            ))}
        </ul>
    </nav>
)}

<script>
    function initScrollSpy() {
        const headings = document.querySelectorAll('h2[id], h3[id]');
        const tocLinks = document.querySelectorAll('.toc-link');
        
        if (!headings.length || !tocLinks.length) return;
        
        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    const id = entry.target.getAttribute('id');
                    const tocLink = document.querySelector(`.toc-link[data-heading-id="${id}"]`);
                    
                    if (!tocLink) return;
                    
                    if (entry.isIntersecting) {
                        // Remove active from all links
                        tocLinks.forEach((link) => {
                            link.classList.remove('text-gray-900', 'font-medium');
                            link.classList.add('text-gray-600');
                        });
                        
                        // Add active to current link
                        tocLink.classList.remove('text-gray-600');
                        tocLink.classList.add('text-gray-900', 'font-medium');
                    }
                });
            },
            {
                rootMargin: '-100px 0px -66%',
                threshold: 1.0
            }
        );
        
        headings.forEach((heading) => observer.observe(heading));
    }
    
    // Initialize on load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initScrollSpy);
    } else {
        initScrollSpy();
    }
</script>

<style>
    .toc-container {
        scrollbar-width: thin;
        scrollbar-color: #d1d5db transparent;
    }
    
    .toc-container::-webkit-scrollbar {
        width: 4px;
    }
    
    .toc-container::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .toc-container::-webkit-scrollbar-thumb {
        background-color: #d1d5db;
        border-radius: 2px;
    }
</style>
