---
import type { Heading } from '../utils/add-heading-ids';

interface Props {
    currentPath?: string;
    headings?: Heading[];
}

const { currentPath = "/", headings = [] } = Astro.props;

// Determine back link based on current path
const isArticlePage = currentPath.startsWith('/blog/') && currentPath !== '/blog' && currentPath !== '/blog/';
const backLink = isArticlePage ? '/blog' : '/';
---

<header class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur-sm border-b border-gray-200">
    <!-- Progress bar -->
    <div id="progress-bar" class="absolute bottom-[-1px] left-0 h-0.5 bg-blue-600 transition-all duration-150" style="width: 0%"></div>
    
    <nav class="max-w-5xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
            <!-- Left: Back arrow + ToC select -->
            <div class="flex items-center gap-4 flex-1 mr-6" style="min-height: 42px;">
                <a href={backLink} class="text-gray-600 hover:text-blue-600 transition-colors flex-shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                </a>
                
                {headings.length > 0 && (
                    <div class="relative group flex-1">
                        <div class="border border-gray-300 rounded bg-white group-hover:rounded-b-none group-hover:border-b-transparent transition-all">
                            <button
                                class="w-full text-sm text-gray-600 px-3 py-2 flex items-center justify-between gap-2 transition-colors"
                                style="min-height: 42px;"
                            >
                                <span>Jump to...</span>
                                <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                        </div>
                        <ul class="hidden group-hover:block absolute left-0 right-0 top-full bg-white border border-gray-300 border-t-0 rounded-b shadow-lg overflow-hidden z-50 max-h-[400px] overflow-y-auto">
                            <li>
                                <a
                                    href="#"
                                    class="block px-4 py-2.5 text-sm transition-all hover:bg-gray-50 text-gray-500 italic font-mono"
                                    onclick="window.scrollTo({top: 0, behavior: 'smooth'}); return false;"
                                >
                                    GOTO 0;
                                </a>
                            </li>
                            {(() => {
                                let h2Counter = 0;
                                let h3Counter = 0;
                                return headings.map((heading) => {
                                    if (heading.level === 2) {
                                        h2Counter++;
                                        h3Counter = 0;
                                        return (
                                            <li>
                                                <a
                                                    href={`#${heading.id}`}
                                                    class="block px-4 py-2.5 text-sm transition-all hover:bg-blue-50 hover:text-blue-600 text-gray-900 font-medium"
                                                >
                                                    <span class="text-blue-600 font-mono mr-2">{h2Counter}.</span>
                                                    {heading.text}
                                                </a>
                                            </li>
                                        );
                                    } else {
                                        h3Counter++;
                                        return (
                                            <li>
                                                <a
                                                    href={`#${heading.id}`}
                                                    class="block px-4 py-2.5 text-sm transition-all hover:bg-gray-50 text-gray-700 pl-8"
                                                >
                                                    <span class="text-gray-400 font-mono mr-2">{h2Counter}.{h3Counter}</span>
                                                    {heading.text}
                                                </a>
                                            </li>
                                        );
                                    }
                                });
                            })()}
                        </ul>
                    </div>
                )}
            </div>
            
            <!-- Right: All content -->
            <div class="flex items-center gap-6 text-sm">
                <a href="/" class="text-lg font-bold tracking-tight text-gray-900 hover:text-blue-600 transition-colors">
                    Miguel Fuertes
                </a>
                <div class="w-px h-4 bg-gray-300"></div>
                <a 
                    href="/blog" 
                    class={`transition-colors ${currentPath.startsWith('/blog') ? 'text-gray-900 font-medium' : 'text-gray-600 hover:text-gray-900'}`}
                >
                    Blog
                </a>
                <a 
                    href="https://github.com/hkfuertes" 
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-gray-600 hover:text-gray-900 transition-colors"
                    aria-label="GitHub"
                >
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                    </svg>
                </a>
                <a 
                    href="https://linkedin.com/in/hkfuertes" 
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-gray-600 hover:text-gray-900 transition-colors"
                    aria-label="LinkedIn"
                >
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                    </svg>
                </a>
                <div class="w-px h-4 bg-gray-300"></div>
                <a 
                    href="/Miguel_Fuertes_CV.pdf" 
                    target="_blank"
                    class="text-gray-900 hover:text-blue-600 transition-colors font-semibold"
                >
                    RESUME
                </a>
            </div>
        </div>
    </nav>
</header>

<!-- Spacer para compensar el fixed header -->
<div class="h-[57px]"></div>

<script>
    // Update progress bar on scroll
    function updateProgressBar() {
        const progressBar = document.getElementById('progress-bar');
        if (!progressBar) return;
        
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight - windowHeight;
        const scrolled = window.scrollY;
        const progress = (scrolled / documentHeight) * 100;
        
        progressBar.style.width = `${Math.min(progress, 100)}%`;
    }
    
    window.addEventListener('scroll', updateProgressBar, { passive: true });
    window.addEventListener('resize', updateProgressBar, { passive: true });
    
    // Initial call
    updateProgressBar();
</script>
