---
import type { Heading } from '../utils/add-heading-ids';
import { Icon } from "astro-icon/components";

interface Props {
    currentPath?: string;
    headings?: Heading[];
}

const { currentPath = "/", headings = [] } = Astro.props;

const hasLeftSlot = Astro.slots.has('left');

// Determine back link based on current path
const isArticlePage = currentPath.startsWith('/blog/') && currentPath !== '/blog' && currentPath !== '/blog/';
const backLink = isArticlePage ? '/blog' : '/';
---

<header class="fixed top-0 left-0 right-0 z-50 bg-[#0f1114]/90 backdrop-blur-sm border-b border-[#2a2e38]">
    <!-- Progress bar -->
    <div id="progress-bar" class="absolute bottom-[-1px] left-0 h-0.5 bg-emerald-400 transition-all duration-150" style="width: 0%"></div>
    
    <nav class="max-w-5xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
            <!-- Left: Back arrow + slot (search/toc) -->
            <div class="flex items-center gap-4 flex-1 mr-6" style="min-height: 42px;">
                <a href={backLink} class="text-gray-400 hover:text-emerald-300 transition-colors flex-shrink-0">
                    <Icon name="tabler:arrow-left" class="w-5 h-5" />
                </a>
                
                {hasLeftSlot ? (
                    <slot name="left" />
                ) : headings.length > 0 && (
                    <div class="relative group flex-1">
                        <div class="border border-[#2a2e38] rounded bg-[#1a1d23] group-hover:rounded-b-none group-hover:border-b-transparent transition-all">
                            <button
                                class="w-full text-sm text-gray-400 px-3 py-2 flex items-center justify-between gap-2 transition-colors"
                                style="min-height: 42px;"
                            >
                                <span>Jump to...</span>
                                <Icon name="tabler:chevron-down" class="w-4 h-4 transition-transform group-hover:rotate-180" />
                            </button>
                        </div>
                        <ul class="hidden group-hover:block absolute left-0 right-0 top-full bg-[#1a1d23] border border-[#2a2e38] border-t-0 rounded-b shadow-lg overflow-hidden z-50 max-h-[400px] overflow-y-auto">
                            <li>
                                <a
                                    href="#"
                                    class="block px-4 py-2.5 text-sm transition-all hover:bg-[#2a2e38] text-gray-400 italic font-mono"
                                    onclick="window.scrollTo({top: 0, behavior: 'smooth'}); return false;"
                                >
                                    GOTO 0;
                                </a>
                            </li>
                            {(() => {
                                let h2Counter = 0;
                                let h3Counter = 0;
                                return headings.map((heading) => {
                                    if (heading.level === 2) {
                                        h2Counter++;
                                        h3Counter = 0;
                                        return (
                                            <li>
                                                <a
                                                    href={`#${heading.id}`}
                                                    class="block px-4 py-2.5 text-sm transition-all hover:bg-[#2a2e38] hover:text-emerald-300 text-gray-100 font-medium"
                                                >
                                                    <span class="text-emerald-400 font-mono mr-2">{h2Counter}.</span>
                                                    {heading.text}
                                                </a>
                                            </li>
                                        );
                                    } else {
                                        h3Counter++;
                                        return (
                                            <li>
                                                <a
                                                    href={`#${heading.id}`}
                                                    class="block px-4 py-2.5 text-sm transition-all hover:bg-[#2a2e38] text-gray-300 pl-8"
                                                >
                                                    <span class="text-gray-500 font-mono mr-2">{h2Counter}.{h3Counter}</span>
                                                    {heading.text}
                                                </a>
                                            </li>
                                        );
                                    }
                                });
                            })()}
                        </ul>
                    </div>
                )}
            </div>
            
            <!-- Right: All content -->
            <div class="flex items-center gap-6 text-sm">
                <a href="/" class="text-lg font-bold tracking-tight text-gray-100 hover:text-emerald-300 transition-colors">
                    Miguel Fuertes
                </a>
                <a 
                    href="https://github.com/hkfuertes" 
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-gray-400 hover:text-emerald-300 transition-colors"
                    aria-label="GitHub"
                >
                    <Icon name="tabler:brand-github" class="w-5 h-5" />
                </a>
                <a 
                    href="https://linkedin.com/in/hkfuertes" 
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-gray-400 hover:text-emerald-300 transition-colors"
                    aria-label="LinkedIn"
                >
                    <Icon name="tabler:brand-linkedin" class="w-5 h-5" />
                </a>
                <a 
                    href="/Miguel_Fuertes_CV.pdf" 
                    target="_blank"
                    class="inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium border border-[#2a2e38] text-gray-300 uppercase tracking-wider transition-all hover:bg-emerald-600 hover:text-white hover:border-emerald-600"
                >
                    <Icon name="tabler:download" class="w-3.5 h-3.5" />
                    RESUME
                </a>
            </div>
        </div>
    </nav>
</header>

<!-- Spacer para compensar el fixed header -->
<div class="h-[57px]"></div>

<script>
    // Update progress bar on scroll
    function updateProgressBar() {
        const progressBar = document.getElementById('progress-bar');
        if (!progressBar) return;
        
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight - windowHeight;
        const scrolled = window.scrollY;
        const progress = (scrolled / documentHeight) * 100;
        
        progressBar.style.width = `${Math.min(progress, 100)}%`;
    }
    
    window.addEventListener('scroll', updateProgressBar, { passive: true });
    window.addEventListener('resize', updateProgressBar, { passive: true });
    
    // Initial call
    updateProgressBar();
</script>
