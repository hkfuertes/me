---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { addHeadingIds } from "../../utils/add-heading-ids";
import { Icon } from "astro-icon/components";

export async function getStaticPaths() {
    const gists = await getCollection("gists");
    const githubRepos = await getCollection("githubRepos");

    return [...gists, ...githubRepos].map((post) => ({
        params: { id: post.id },
        props: { post },
    }));
}

const { post } = Astro.props;

// Determine the type based on collection
const isGitHub = post.id.includes('-');
const typeLabel = isGitHub ? 'Project' : 'Writing';

// Add IDs to headings and extract ToC
const { html, headings } = addHeadingIds(post.rendered?.html || '');

function formatDate(date: Date) {
    return date.toLocaleDateString("en-US", {
        month: "long",
        day: "numeric",
        year: "numeric"
    });
}
---

<BaseLayout title={`${post.data.title} - Miguel Fuertes`} description={post.data.description} headings={headings}>
    <div class="min-h-screen bg-[#0a1a0f]">
        <!-- Grid de fondo -->
        <div class="fixed inset-0 bg-[linear-gradient(to_right,#ffffff08_1px,transparent_1px),linear-gradient(to_bottom,#ffffff08_1px,transparent_1px)] bg-[size:24px_24px] pointer-events-none"></div>
        
        <div class="relative max-w-5xl mx-auto px-6 py-12">
            <!-- Article container with white background -->
            <article class="bg-[#0f2415] border border-[#1a3a24]">
                <header class="bg-[#0a1a0f] px-8 md:px-12 pt-8 md:pt-12 pb-12 mb-16 border-b border-[#1a3a24]">
                    <div class="mb-4">
                        <span class="inline-block px-2 py-1 text-xs font-medium border border-[#1a3a24] text-gray-300 uppercase tracking-wider">
                            {typeLabel}
                        </span>
                    </div>
                    
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-100 mb-4 leading-tight">
                        {post.data.title}
                    </h1>
                    
                    {post.data.description && (
                        <p class="text-xl text-gray-400 font-light mb-4">
                            {post.data.description}
                        </p>
                    )}
                    
                    <div class="flex items-center gap-4 text-sm text-gray-400">
                        <time datetime={post.data.date.toISOString()}>
                            {formatDate(post.data.date)}
                        </time>
                        
                        {/* GitHub stats for project READMEs */}
                        {isGitHub && (
                            <>
                                {post.data.stars !== undefined && post.data.stars > 0 && (
                                    <>
                                        <span>·</span>
                                        <div class="flex items-center gap-1 text-gray-400">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                            </svg>
                                            {post.data.stars} stars
                                        </div>
                                    </>
                                )}
                                {post.data.forks !== undefined && post.data.forks > 0 && (
                                    <>
                                        <span>·</span>
                                        <div class="flex items-center gap-1 text-gray-400">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M8 3a3 3 0 100 6 3 3 0 000-6zm8 12a3 3 0 100 6 3 3 0 000-6zM7 7v4a4 4 0 004 4h2a4 4 0 004-4V7M16 3a3 3 0 100 6 3 3 0 000-6z"/>
                                            </svg>
                                            {post.data.forks} forks
                                        </div>
                                    </>
                                )}
                            </>
                        )}
                        
                        {post.data.url && (
                            <>
                                <span>·</span>
                                <a 
                                    href={post.data.url} 
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="text-emerald-400 hover:text-emerald-300 inline-flex items-center gap-1"
                                >
                                    View on GitHub
                                    <Icon name="tabler:external-link" class="w-3 h-3" />
                                </a>
                            </>
                        )}
                    </div>
                </header>

                <!-- Content -->
                <div class="article-content px-8 md:px-12 pb-8 md:pb-12" set:html={html} />
            </article>
        </div>
    </div>
</BaseLayout>

<style>
    /* Smooth scroll for anchor links */
    html {
        scroll-behavior: smooth;
        scroll-padding-top: 100px; /* Account for fixed header */
    }
    
    .article-content {
        max-width: none;
        font-size: 1.125rem;
        line-height: 1.75;
    }
    
    /* Headings */
    .article-content :global(h1),
    .article-content :global(h2),
    .article-content :global(h3),
    .article-content :global(h4),
    .article-content :global(h5),
    .article-content :global(h6) {
        color: #f3f4f6;
        font-weight: 700;
        margin-top: 2em;
        margin-bottom: 1em;
        line-height: 1.25;
    }
    
    .article-content :global(h1) { font-size: 2.25em; }
    .article-content :global(h2) { font-size: 1.875em; }
    .article-content :global(h3) { font-size: 1.5em; }
    
    /* Paragraphs */
    .article-content :global(p) {
        color: #d1d5db;
        margin-bottom: 1.25em;
    }
    
    /* Links */
    .article-content :global(a) {
        color: #6ee7b7;
        text-decoration: underline;
        text-decoration-color: #2d5a3d;
    }
    
    .article-content :global(a:hover) {
        color: #a7f3d0;
        text-decoration-color: #6ee7b7;
    }
    
    /* Inline code */
    .article-content :global(code:not(pre code)) {
        color: #a7f3d0;
        background-color: #0a1a0f;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        font-size: 0.875em;
        font-family: ui-monospace, monospace;
    }
    
    /* Code blocks - let Shiki handle all styling */
    .article-content :global(pre) {
        border-radius: 0.5rem;
        padding: 1rem;
        overflow-x: auto;
        margin: 1.5em 0;
    }
    
    .article-content :global(pre code) {
        padding: 0 !important;
        font-size: 0.875rem;
        line-height: 1.7;
    }
    
    /* Lists */
    .article-content :global(ul),
    .article-content :global(ol) {
        color: #d1d5db;
        margin-bottom: 1.25em;
        padding-left: 1.625em;
        list-style-position: outside;
    }
    
    .article-content :global(ul) {
        list-style-type: disc;
    }
    
    .article-content :global(ol) {
        list-style-type: decimal;
    }
    
    .article-content :global(li) {
        margin-bottom: 0.5em;
        display: list-item;
    }
    
    /* Blockquotes */
    .article-content :global(blockquote) {
        border-left: 4px solid #6ee7b7;
        padding-left: 1em;
        color: #d1d5db;
        font-style: italic;
        margin: 1.5em 0;
    }
    
    /* Horizontal rule */
    .article-content :global(hr) {
        border: 0;
        border-top: 1px solid #1a3a24;
        margin: 2em 0;
    }
    
    /* Strong/Bold */
    .article-content :global(strong) {
        color: #f9fafb;
        font-weight: 600;
    }
    
    /* Tables */
    .article-content :global(table) {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5em 0;
        display: block;
        overflow-x: auto;
    }
    
    .article-content :global(th),
    .article-content :global(td) {
        border: 1px solid #1a3a24;
        padding: 0.75em;
        text-align: left;
        white-space: nowrap;
    }
    
    .article-content :global(th) {
        background-color: #0a1a0f;
        font-weight: 600;
    }
</style>
