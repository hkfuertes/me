---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { loadCV } from "../utils/cv-loader";

// Cargar todos los datos
const posts = await getCollection("blog");
const gists = await getCollection("gists");
const githubProjects = await getCollection("github");
const cvData = loadCV();
const { projects: cvProjects = [] } = cvData.cv.sections;

// Unificar todo en un solo array con tipos
const allWork = [
    // Posts y gists
    ...[...posts, ...gists].map(item => ({
        type: 'post',
        title: item.data.title,
        date: item.data.date,
        description: item.data.description,
        url: `/work/${item.id}`,
        externalUrl: item.data.url,
        tags: item.data.tags || []
    })),
    // GitHub READMEs
    ...githubProjects.map(item => ({
        type: 'github',
        title: item.data.title,
        date: item.data.date,
        description: item.data.description,
        url: `/work/${item.id}`,
        externalUrl: item.data.url,
        tags: item.data.tags || [],
        stars: item.data.stars || 0,
        forks: item.data.forks || 0,
        language: item.data.language
    })),
    // Proyectos personales (solo los que NO tienen URL de GitHub)
    ...cvProjects.filter(proj => !proj.name?.includes('github.com')).map(proj => ({
        type: 'project',
        title: proj.name,
        date: new Date(proj.end_date || new Date()),
        description: proj.summary,
        tags: [],
        highlights: proj.highlights || []
    }))
];

// Ordenar por fecha (más reciente primero)
const sortedWork = allWork.sort((a, b) => b.date.getTime() - a.date.getTime());

// Obtener años únicos
const years = [...new Set(sortedWork.map(item => item.date.getFullYear()))].sort((a, b) => b - a);

function formatDate(date: Date) {
    return date.toLocaleDateString("en-US", {
        month: "short",
        year: "numeric"
    });
}

function getTypeLabel(type: string) {
    const labels = {
        'post': 'Writing',
        'experience': 'Work',
        'project': 'Project',
        'github': 'Project'
    };
    return labels[type] || type;
}
---

<BaseLayout title="Work - Miguel Fuertes">
    <div class="min-h-screen bg-white">
        <!-- Grid de fondo -->
        <div class="fixed inset-0 bg-[linear-gradient(to_right,#80808008_1px,transparent_1px),linear-gradient(to_bottom,#80808008_1px,transparent_1px)] bg-[size:24px_24px] pointer-events-none"></div>
        
        <div class="relative max-w-5xl mx-auto px-6 py-12">
            <!-- Header -->
            <div class="mb-16">
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="md:col-span-2">
                        <h1 class="text-5xl md:text-6xl font-bold tracking-tight mb-4">Work</h1>
                        <div class="h-1 w-16 bg-blue-600 mb-6"></div>
                        <p class="text-lg text-gray-600 font-light">
                            A chronological collection of professional experience, personal projects, and writings.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Timeline por años -->
            {years.map(year => {
                const yearItems = sortedWork.filter(item => item.date.getFullYear() === year);
                
                return (
                    <div class="mb-16">
                        <!-- Año como separador -->
                        <div class="flex items-center gap-4 mb-8">
                            <div class="text-3xl font-bold text-gray-900">{year}</div>
                            <div class="flex-1 h-px bg-gray-200"></div>
                        </div>
                        
                        <!-- Items del año -->
                        <div class="space-y-6">
                            {yearItems.map(item => (
                                <article class="grid md:grid-cols-4 gap-6 group">
                                    <!-- Columna 1: Fecha y tipo -->
                                    <div class="md:col-span-1">
                                        <div class="text-sm text-gray-500 mb-2">{formatDate(item.date)}</div>
                                        <div class="inline-block px-2 py-1 text-xs font-medium border border-gray-300 text-gray-700 uppercase tracking-wider">
                                            {getTypeLabel(item.type)}
                                        </div>
                                    </div>
                                    
                                    <!-- Columna 2-4: Contenido -->
                                    <div class="md:col-span-3">
                                        {item.url ? (
                                            <a href={item.url} class="block group/link">
                                                <h2 class="text-xl font-bold text-gray-900 mb-2 group-hover/link:text-blue-600 transition-colors">
                                                    {item.title}
                                                    {item.subtitle && <span class="text-gray-600"> — {item.subtitle}</span>}
                                                </h2>
                                            </a>
                                        ) : (
                                            <h2 class="text-xl font-bold text-gray-900 mb-2">
                                                {item.title}
                                                {item.subtitle && <span class="text-gray-600"> — {item.subtitle}</span>}
                                            </h2>
                                        )}
                                        
                                        {item.location && (
                                            <div class="text-sm text-gray-500 mb-2">{item.location}</div>
                                        )}
                                        
                                        <p class="text-gray-700 leading-relaxed mb-3">
                                            {item.description}
                                        </p>
                                        
                                        {(item.stars !== undefined || item.language) && (
                                            <div class="flex items-center gap-4 text-sm text-gray-600 mb-3">
                                                {item.stars !== undefined && item.stars > 0 && (
                                                    <div class="flex items-center gap-1">
                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                                        </svg>
                                                        {item.stars}
                                                    </div>
                                                )}
                                                {item.forks !== undefined && item.forks > 0 && (
                                                    <div class="flex items-center gap-1">
                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                            <path d="M8 3a3 3 0 100 6 3 3 0 000-6zm8 12a3 3 0 100 6 3 3 0 000-6zM7 7v4a4 4 0 004 4h2a4 4 0 014-4V7M16 3a3 3 0 100 6 3 3 0 000-6z"/>
                                                        </svg>
                                                        {item.forks}
                                                    </div>
                                                )}
                                                {item.language && (
                                                    <div class="px-2 py-0.5 bg-gray-100 border border-gray-200 text-xs">
                                                        {item.language}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        
                                        {item.externalUrl && (
                                            <a 
                                                href={item.externalUrl} 
                                                target="_blank"
                                                class="text-sm text-blue-600 hover:text-blue-700 inline-flex items-center gap-1"
                                            >
                                                View on GitHub
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                                </svg>
                                            </a>
                                        )}
                                        
                                        {item.tags && item.tags.length > 0 && (
                                            <div class="flex flex-wrap gap-2 mt-3">
                                                {item.tags.slice(0, 5).map(tag => (
                                                    <span class="text-xs text-gray-600 border border-gray-200 px-2 py-1">
                                                        {tag}
                                                    </span>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </article>
                            ))}
                        </div>
                    </div>
                );
            })}
        </div>
    </div>
</BaseLayout>
