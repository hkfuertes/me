---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { loadCV } from "../utils/cv-loader";

// Cargar todos los datos
const posts = await getCollection("blog");
const gists = await getCollection("gists");
const githubProjects = await getCollection("github");
const cvData = loadCV();
const { projects: cvProjects = [] } = cvData.cv.sections;

// Unificar todo en un solo array con tipos
const allWork = [
    // Posts y gists
    ...[...posts, ...gists].map(item => ({
        type: 'post',
        title: item.data.title,
        date: item.data.date,
        description: item.data.description,
        url: `/blog/${item.id}`,
        externalUrl: item.data.url,
        tags: item.data.tags || []
    })),
    // GitHub READMEs
    ...githubProjects.map(item => ({
        type: 'github',
        title: item.data.title,
        date: item.data.date,
        description: item.data.description,
        url: `/blog/${item.id}`,
        externalUrl: item.data.url,
        tags: item.data.tags || [],
        stars: item.data.stars || 0,
        forks: item.data.forks || 0,
        language: item.data.language
    })),
    // Proyectos personales (solo los que NO tienen URL de GitHub)
    ...cvProjects.filter(proj => !proj.name?.includes('github.com')).map(proj => ({
        type: 'project',
        title: proj.name,
        date: new Date(proj.end_date || new Date()),
        description: proj.summary,
        tags: [],
        highlights: proj.highlights || []
    }))
];

// Ordenar por fecha (más reciente primero)
const sortedWork = allWork.sort((a, b) => b.date.getTime() - a.date.getTime());

// Obtener años únicos
const years = [...new Set(sortedWork.map(item => item.date.getFullYear()))].sort((a, b) => b - a);

function formatDate(date: Date) {
    return date.toLocaleDateString("en-US", {
        month: "short",
        year: "numeric"
    });
}

function getTypeLabel(type: string) {
    const labels = {
        'post': 'Writing',
        'experience': 'Work',
        'project': 'Project',
        'github': 'Project'
    };
    return labels[type] || type;
}
---

<BaseLayout title="Work - Miguel Fuertes">
    <div class="min-h-screen bg-white">
        <!-- Grid de fondo -->
        <div class="fixed inset-0 bg-[linear-gradient(to_right,#80808008_1px,transparent_1px),linear-gradient(to_bottom,#80808008_1px,transparent_1px)] bg-[size:24px_24px] pointer-events-none"></div>
        
        <div class="relative max-w-5xl mx-auto px-6 py-12">
            <!-- Header - Solo descripción -->
            <div class="mb-16">
                <p class="text-lg text-gray-600 font-light max-w-3xl">
                    A chronological collection of professional experience, personal projects, and writings.
                </p>
            </div>
            
            <!-- Timeline por años -->
            {years.map(year => {
                const yearItems = sortedWork.filter(item => item.date.getFullYear() === year);
                
                return (
                    <div class="mb-12">
                        <!-- Año como separador -->
                        <div class="flex items-center gap-4 mb-8">
                            <div class="text-3xl font-bold text-gray-900">{year}</div>
                            <div class="flex-1 h-px bg-gray-200"></div>
                        </div>
                        
                        <!-- Items del año -->
                        <div class="grid md:grid-cols-3 gap-4">
                            {yearItems.map(item => (
                                <article class="border border-gray-300 p-4 hover:border-blue-600 transition-colors group">
                                    {item.url ? (
                                        <a href={item.url} class="block group/link">
                                            <h2 class="text-lg font-bold text-gray-900 mb-2 group-hover/link:text-blue-600 transition-colors">
                                                {item.title}
                                            </h2>
                                        </a>
                                    ) : (
                                        <h2 class="text-lg font-bold text-gray-900 mb-2">
                                            {item.title}
                                        </h2>
                                    )}
                                    
                                    <div class="flex items-center gap-2 text-xs">
                                        <div class="text-gray-500">{formatDate(item.date)}</div>
                                        <div class="text-gray-300">•</div>
                                        <div class="inline-block px-2 py-0.5 font-medium border border-gray-300 text-gray-700 uppercase tracking-wider">
                                            {getTypeLabel(item.type)}
                                        </div>
                                    </div>
                                </article>
                            ))}
                        </div>
                    </div>
                );
            })}
        </div>
    </div>
</BaseLayout>
