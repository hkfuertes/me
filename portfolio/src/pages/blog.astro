---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { Icon } from "astro-icon/components";

// Cargar solo gists y repos públicos de GitHub
const gists = await getCollection("gists");
const githubRepos = await getCollection("githubRepos");
const contributions = await getCollection("contributions");

// Unificar todo en un solo array con tipos
const allWork = [
    // Gists
    ...gists.map(item => ({
        type: 'gist',
        title: item.data.title,
        date: item.data.date,
        updated: item.data.updated,
        description: item.data.description,
        url: `/blog/${item.id}`,
        externalUrl: item.data.url,
        tags: item.data.tags || [],
        stars: item.data.stars || 0,
        forks: item.data.forks || 0
    })),
    // GitHub Repos públicos (automático)
    ...githubRepos.map(item => ({
        type: 'github',
        title: item.data.title,
        date: item.data.date,
        updated: item.data.updated,
        description: item.data.description,
        url: item.rendered?.html ? `/blog/${item.id}` : item.data.url, // Si no hay README, enlazar al repo
        externalUrl: item.data.url,
        tags: item.data.tags || [],
        stars: item.data.stars || 0,
        forks: item.data.forks || 0,
        language: item.data.language,
        hasReadme: !!item.rendered?.html
    })),
    // Contribuciones (PRs merged a proyectos de terceros)
    ...contributions.map(item => ({
        type: 'contribution',
        title: item.data.title,
        date: item.data.mergedAt || item.data.date, // Usar fecha de merge si existe, sino creación
        updated: item.data.updated,
        description: item.data.repo, // Nombre del repo como descripción
        url: item.data.url, // Link directo al PR
        externalUrl: item.data.url,
        tags: item.data.tags || [],
        stars: 0,
        forks: 0,
        repo: item.data.repo,
        additions: item.data.additions || 0,
        deletions: item.data.deletions || 0,
        prNumber: item.data.prNumber,
        state: item.data.state || 'open'
    }))
];

// Ordenar por fecha (más reciente primero)
const sortedWork = allWork.sort((a, b) => b.date.getTime() - a.date.getTime());

// Obtener años únicos
const years = [...new Set(sortedWork.map(item => item.date.getFullYear()))].sort((a, b) => b - a);

function formatDate(date: Date) {
    return date.toLocaleDateString("en-US", {
        month: "short",
        year: "numeric"
    });
}

function formatUpdatedDate(date: Date) {
    const now = new Date();
    const diffTime = Math.abs(now.getTime() - date.getTime());
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 7) {
        return `Updated ${diffDays}d ago`;
    } else if (diffDays < 30) {
        const weeks = Math.floor(diffDays / 7);
        return `Updated ${weeks}w ago`;
    } else if (diffDays < 365) {
        const months = Math.floor(diffDays / 30);
        return `Updated ${months}mo ago`;
    } else {
        const years = Math.floor(diffDays / 365);
        return `Updated ${years}y ago`;
    }
}

function getTypeLabel(type: string) {
    const labels = {
        'gist': 'Writing',
        'github': 'Project',
        'contribution': 'Contribution'
    };
    return labels[type] || type;
}
---

<BaseLayout title="Work - Miguel Fuertes">
    <div class="min-h-screen bg-white">
        <!-- Grid de fondo -->
        <div class="fixed inset-0 bg-[linear-gradient(to_right,#80808008_1px,transparent_1px),linear-gradient(to_bottom,#80808008_1px,transparent_1px)] bg-[size:24px_24px] pointer-events-none"></div>
        
        <div class="relative max-w-5xl mx-auto px-6 py-12">
            <!-- Header - Solo descripción -->
            <div class="mb-16">
                <p class="text-lg text-gray-600 font-light max-w-3xl">
                    A chronological collection of professional experience, personal projects, and writings.
                </p>
            </div>
            
            <!-- Timeline por años -->
            {years.map(year => {
                const yearItems = sortedWork.filter(item => item.date.getFullYear() === year);
                
                return (
                    <div class="mb-12">
                        <!-- Año como separador -->
                        <div class="flex items-center gap-4 mb-8">
                            <div class="text-3xl font-bold text-gray-900">{year}</div>
                            <div class="flex-1 h-px bg-gray-200"></div>
                        </div>
                        
                        <!-- Items del año -->
                        <div class="grid md:grid-cols-3 gap-4">
                            {yearItems.map(item => (
                                <article class="border border-gray-300 p-4 hover:border-gray-800 transition-colors group flex flex-col relative">
                                    {/* Updated badge - esquina superior derecha */}
                                    {item.updated && item.updated.getTime() !== item.date.getTime() && (
                                        <div class="absolute top-3 right-3 text-gray-400 text-[10px]">
                                            {formatUpdatedDate(item.updated)}
                                        </div>
                                    )}
                                    
                                    {item.url ? (
                                        <a 
                                            href={item.url} 
                                            class="block group/link flex-1 pr-16"
                                            target={item.type === 'contribution' || (item.type === 'github' && !item.hasReadme) ? '_blank' : undefined}
                                            rel={item.type === 'contribution' || (item.type === 'github' && !item.hasReadme) ? 'noopener noreferrer' : undefined}
                                        >
                                            <h2 class="text-lg font-bold text-gray-900 mb-2 group-hover/link:text-gray-800 transition-colors line-clamp-1">
                                                {item.title}
                                            </h2>
                                            <p class="text-sm text-gray-600 mb-3 line-clamp-1">
                                                {item.description ? (
                                                    item.description
                                                ) : (
                                                    <span class="italic text-gray-400">Interesting project...</span>
                                                )}
                                            </p>
                                        </a>
                                    ) : (
                                        <div class="flex-1 pr-16">
                                            <h2 class="text-lg font-bold text-gray-900 mb-2 line-clamp-1">
                                                {item.title}
                                            </h2>
                                            <p class="text-sm text-gray-600 mb-3 line-clamp-1">
                                                {item.description ? (
                                                    item.description
                                                ) : (
                                                    <span class="italic text-gray-400">Interesting project...</span>
                                                )}
                                            </p>
                                        </div>
                                    )}
                                    
                                    <div class="flex items-center gap-2 text-xs mt-auto">
                                        <div class="text-gray-500">{formatDate(item.date)}</div>
                                        <div class="text-gray-300">•</div>
                                        <div class={`inline-block px-2 py-0.5 font-medium border text-gray-700 uppercase tracking-wider ${
                                            item.type === 'contribution' && item.state === 'open' 
                                                ? 'border-green-500 text-green-700' 
                                                : 'border-gray-300'
                                        }`}>
                                            {getTypeLabel(item.type)}
                                        </div>
                                        {item.stars > 0 && (
                                            <>
                                                <div class="text-gray-300">•</div>
                                                <div class="text-gray-800 flex items-center gap-1">
                                                    <Icon name="tabler:star" class="w-3 h-3" />
                                                    <span>{item.stars}</span>
                                                </div>
                                            </>
                                        )}
                                        {item.forks > 0 && (
                                            <>
                                                <div class="text-gray-300">•</div>
                                                <div class="text-gray-800 flex items-center gap-1">
                                                    <Icon name="tabler:git-fork" class="w-3 h-3" />
                                                    <span>{item.forks}</span>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                </article>
                            ))}
                        </div>
                    </div>
                );
            })}
        </div>
    </div>
</BaseLayout>
