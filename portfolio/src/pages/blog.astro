---
import '../layouts/../styles/global.css'
import TopBar from "../components/TopBar.astro";
import { getCollection } from "astro:content";
import { Icon } from "astro-icon/components";

// Cargar solo gists y repos públicos de GitHub
const gists = await getCollection("gists");
const githubRepos = await getCollection("githubRepos");
const contributions = await getCollection("contributions");

// Unificar todo en un solo array con tipos
const allWork = [
    // Gists
    ...gists.map(item => ({
        type: 'gist',
        title: item.data.title,
        date: item.data.date,
        updated: item.data.updated,
        description: item.data.description,
        url: `/blog/${item.id}`,
        externalUrl: item.data.url,
        tags: item.data.tags || [],
        stars: item.data.stars || 0,
        forks: item.data.forks || 0
    })),
    // GitHub Repos públicos (automático)
    ...githubRepos.map(item => ({
        type: 'github',
        title: item.data.title,
        date: item.data.date,
        updated: item.data.updated,
        description: item.data.description,
        url: item.data.show_readme ? `/blog/${item.id}` : item.data.url, // Si show_readme es false, enlazar directo al repo
        externalUrl: item.data.url,
        tags: item.data.tags || [],
        stars: item.data.stars || 0,
        forks: item.data.forks || 0,
        language: item.data.language,
        showReadme: item.data.show_readme || false
    })),
    // Contribuciones (PRs merged a proyectos de terceros)
    ...contributions.map(item => ({
        type: 'contribution',
        title: item.data.title,
        date: item.data.mergedAt || item.data.date, // Usar fecha de merge si existe, sino creación
        updated: item.data.updated,
        description: item.data.repo, // Nombre del repo como descripción
        url: item.data.url, // Link directo al PR
        externalUrl: item.data.url,
        tags: item.data.tags || [],
        stars: 0,
        forks: 0,
        repo: item.data.repo,
        additions: item.data.additions || 0,
        deletions: item.data.deletions || 0,
        prNumber: item.data.prNumber,
        state: item.data.state || 'open'
    }))
];

// Ordenar por fecha (más reciente primero)
const sortedWork = allWork.sort((a, b) => b.date.getTime() - a.date.getTime());

// Obtener años únicos
const years = [...new Set(sortedWork.map(item => item.date.getFullYear()))].sort((a, b) => b - a);

function formatDate(date: Date) {
    return date.toLocaleDateString("en-US", {
        month: "short",
        year: "numeric"
    });
}

function formatUpdatedDate(date: Date) {
    const now = new Date();
    const diffTime = Math.abs(now.getTime() - date.getTime());
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 7) {
        return `Updated ${diffDays}d ago`;
    } else if (diffDays < 30) {
        const weeks = Math.floor(diffDays / 7);
        return `Updated ${weeks}w ago`;
    } else if (diffDays < 365) {
        const months = Math.floor(diffDays / 30);
        return `Updated ${months}mo ago`;
    } else {
        const years = Math.floor(diffDays / 365);
        return `Updated ${years}y ago`;
    }
}

function getTypeLabel(type: string) {
    const labels = {
        'gist': 'Writing',
        'github': 'Project',
        'contribution': 'Contribution'
    };
    return labels[type] || type;
}
---

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Senior Software Engineer with 10+ years experience in backend development, cloud platforms, and embedded systems." />
    <meta name="author" content="Miguel Fuertes" />
    <title>Work - Miguel Fuertes</title>
</head>
<body class="bg-[#0f1114] text-gray-100 min-h-screen antialiased transition-colors">
    <TopBar currentPath={Astro.url.pathname}>
        <input 
            slot="left"
            type="text" 
            id="search-input"
            placeholder="Filter by title..."
            class="flex-1 px-3 py-2 border border-[#2a2e38] bg-[#1a1d23] text-gray-100 placeholder:text-gray-400 text-sm focus:outline-none focus:border-emerald-500 transition-colors"
            style="min-height: 42px;"
        />
    </TopBar>
    
    <div class="min-h-screen bg-[#0f1114]">
        <!-- Grid de fondo -->
        <div class="fixed inset-0 bg-[linear-gradient(to_right,#ffffff08_1px,transparent_1px),linear-gradient(to_bottom,#ffffff08_1px,transparent_1px)] bg-[size:24px_24px] pointer-events-none"></div>
        
        <div class="relative max-w-5xl mx-auto px-6 py-12">
            <!-- Header -->
            <div class="mb-8">
                <p class="text-lg text-gray-400 font-light max-w-3xl mx-auto text-center italic">
                    Things I've built, written, and contributed to.
                </p>
            </div>
            
            <!-- Timeline por años -->
            <div id="timeline-container">
            {years.map(year => {
                const yearItems = sortedWork.filter(item => item.date.getFullYear() === year);
                
                return (
                    <div class="mb-12">
                        <!-- Año como separador -->
                        <div class="flex items-center gap-4 mb-8">
                            <div class="text-3xl font-bold text-gray-100">{year}</div>
                            <div class="flex-1 h-px bg-[#2a2e38]"></div>
                        </div>
                        
                        <!-- Items del año -->
                        <div class="grid md:grid-cols-3 gap-4">
                            {yearItems.map(item => (
                                <article class="border border-[#2a2e38] bg-[#1a1d23] p-4 hover:border-emerald-600 transition-colors group flex flex-col relative">
                                    {/* Updated badge - esquina superior derecha */}
                                    {item.updated && item.updated.getTime() !== item.date.getTime() && (
                                        <div class="absolute top-3 right-3 text-gray-500 text-[10px]">
                                            {formatUpdatedDate(item.updated)}
                                        </div>
                                    )}
                                    
                                    {/* External link icon - esquina inferior derecha */}
                                    {(item.type === 'contribution' || (item.type === 'github' && !item.showReadme)) && (
                                        <div class="absolute bottom-3 right-3 text-gray-500">
                                            <Icon name="tabler:dots" class="w-4 h-4" />
                                        </div>
                                    )}
                                    
                                    {item.url ? (
                                        <a 
                                            href={item.url} 
                                            class="block group/link flex-1 pr-16"
                                            target={item.type === 'contribution' || (item.type === 'github' && !item.showReadme) ? '_blank' : undefined}
                                            rel={item.type === 'contribution' || (item.type === 'github' && !item.showReadme) ? 'noopener noreferrer' : undefined}
                                        >
                                            <h2 class="text-lg font-bold text-gray-100 mb-2 group-hover/link:text-emerald-300 transition-colors line-clamp-1">
                                                {item.title}
                                            </h2>
                                            <p class="text-sm text-gray-400 mb-3 line-clamp-1">
                                                {item.description ? (
                                                    item.description
                                                ) : (
                                                    <span class="italic text-gray-500">Interesting project...</span>
                                                )}
                                            </p>
                                        </a>
                                    ) : (
                                        <div class="flex-1 pr-16">
                                            <h2 class="text-lg font-bold text-gray-100 mb-2 line-clamp-1">
                                                {item.title}
                                            </h2>
                                            <p class="text-sm text-gray-400 mb-3 line-clamp-1">
                                                {item.description ? (
                                                    item.description
                                                ) : (
                                                    <span class="italic text-gray-500">Interesting project...</span>
                                                )}
                                            </p>
                                        </div>
                                    )}
                                    
                                    <div class="flex items-center gap-2 text-xs mt-auto">
                                        <div class="text-gray-400">{formatDate(item.date)}</div>
                                        <div class="text-gray-600">•</div>
                                        <div class={`inline-block px-2 py-0.5 font-medium border uppercase tracking-wider ${
                                            item.type === 'contribution' && item.state === 'open' 
                                                ? 'border-green-500 text-green-400' 
                                                : item.type === 'github' && !item.showReadme
                                                ? 'border-blue-400 text-blue-300'
                                                : 'border-[#2a2e38] text-gray-300'
                                        }`}>
                                            {getTypeLabel(item.type)}
                                        </div>
                                        {item.stars > 0 && (
                                            <>
                                                <div class="text-gray-600">•</div>
                                                <div class="text-gray-300 flex items-center gap-1">
                                                    <Icon name="tabler:star" class="w-3 h-3" />
                                                    <span>{item.stars}</span>
                                                </div>
                                            </>
                                        )}
                                        {item.forks > 0 && (
                                            <>
                                                <div class="text-gray-600">•</div>
                                                <div class="text-gray-300 flex items-center gap-1">
                                                    <Icon name="tabler:git-fork" class="w-3 h-3" />
                                                    <span>{item.forks}</span>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                </article>
                            ))}
                        </div>
                    </div>
                );
            })}
            </div>
        </div>
    </div>
    
    <script>
        const searchInput = document.getElementById('search-input') as HTMLInputElement;
        const articles = document.querySelectorAll('article');
        
        searchInput?.addEventListener('input', (e) => {
            const query = (e.target as HTMLInputElement).value.toLowerCase();
            
            articles.forEach(article => {
                const title = article.querySelector('h2')?.textContent?.toLowerCase() || '';
                const shouldShow = title.includes(query);
                article.style.display = shouldShow ? 'flex' : 'none';
            });
            
            // Hide year sections if all articles are hidden
            document.querySelectorAll('.mb-12').forEach(yearSection => {
                const visibleArticles = yearSection.querySelectorAll('article:not([style*="display: none"])');
                (yearSection as HTMLElement).style.display = visibleArticles.length > 0 ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>
