---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

// Cargar solo gists y repos públicos de GitHub
const gists = await getCollection("gists");
const githubRepos = await getCollection("githubRepos");

// Unificar todo en un solo array con tipos
const allWork = [
    // Gists
    ...gists.map(item => ({
        type: 'gist',
        title: item.data.title,
        date: item.data.date,
        description: item.data.description,
        url: `/blog/${item.id}`,
        externalUrl: item.data.url,
        tags: item.data.tags || []
    })),
    // GitHub Repos públicos (automático)
    ...githubRepos.map(item => ({
        type: 'github',
        title: item.data.title,
        date: item.data.date,
        description: item.data.description,
        url: `/blog/${item.id}`,
        externalUrl: item.data.url,
        tags: item.data.tags || [],
        stars: item.data.stars || 0,
        forks: item.data.forks || 0,
        language: item.data.language
    }))
];

// Ordenar por fecha (más reciente primero)
const sortedWork = allWork.sort((a, b) => b.date.getTime() - a.date.getTime());

// Obtener años únicos
const years = [...new Set(sortedWork.map(item => item.date.getFullYear()))].sort((a, b) => b - a);

function formatDate(date: Date) {
    return date.toLocaleDateString("en-US", {
        month: "short",
        year: "numeric"
    });
}

function getTypeLabel(type: string) {
    const labels = {
        'gist': 'Gist',
        'github': 'Project'
    };
    return labels[type] || type;
}
---

<BaseLayout title="Work - Miguel Fuertes">
    <div class="min-h-screen bg-white">
        <!-- Grid de fondo -->
        <div class="fixed inset-0 bg-[linear-gradient(to_right,#80808008_1px,transparent_1px),linear-gradient(to_bottom,#80808008_1px,transparent_1px)] bg-[size:24px_24px] pointer-events-none"></div>
        
        <div class="relative max-w-5xl mx-auto px-6 py-12">
            <!-- Header - Solo descripción -->
            <div class="mb-16">
                <p class="text-lg text-gray-600 font-light max-w-3xl">
                    A chronological collection of professional experience, personal projects, and writings.
                </p>
            </div>
            
            <!-- Timeline por años -->
            {years.map(year => {
                const yearItems = sortedWork.filter(item => item.date.getFullYear() === year);
                
                return (
                    <div class="mb-12">
                        <!-- Año como separador -->
                        <div class="flex items-center gap-4 mb-8">
                            <div class="text-3xl font-bold text-gray-900">{year}</div>
                            <div class="flex-1 h-px bg-gray-200"></div>
                        </div>
                        
                        <!-- Items del año -->
                        <div class="grid md:grid-cols-3 gap-4">
                            {yearItems.map(item => (
                                <article class="border border-gray-300 p-4 hover:border-blue-600 transition-colors group flex flex-col">
                                    {item.url ? (
                                        <a href={item.url} class="block group/link flex-1">
                                            <h2 class="text-lg font-bold text-gray-900 mb-2 group-hover/link:text-blue-600 transition-colors line-clamp-1">
                                                {item.title}
                                            </h2>
                                            {item.description && (
                                                <p class="text-sm text-gray-600 mb-3 line-clamp-1">
                                                    {item.description}
                                                </p>
                                            )}
                                        </a>
                                    ) : (
                                        <>
                                            <h2 class="text-lg font-bold text-gray-900 mb-2 line-clamp-1">
                                                {item.title}
                                            </h2>
                                            {item.description && (
                                                <p class="text-sm text-gray-600 mb-3 line-clamp-1">
                                                    {item.description}
                                                </p>
                                            )}
                                        </>
                                    )}
                                    
                                    <div class="flex items-center gap-2 text-xs mt-auto">
                                        <div class="text-gray-500">{formatDate(item.date)}</div>
                                        <div class="text-gray-300">•</div>
                                        <div class="inline-block px-2 py-0.5 font-medium border border-gray-300 text-gray-700 uppercase tracking-wider">
                                            {getTypeLabel(item.type)}
                                        </div>
                                    </div>
                                </article>
                            ))}
                        </div>
                    </div>
                );
            })}
        </div>
    </div>
</BaseLayout>
